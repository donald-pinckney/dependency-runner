const semver = require('semver')
const fetch = require('make-fetch-happen')
const process = require('process');

const args = process.argv.slice(2);
const name = args[0]
const versionStr = args[1]


const url = `https://advisory.federico.codes/api/cached/npm/${name}`
fetch(url).then(res => {
  if (res.status < 200 || res.status > 299) {
    console.log(`Failed to load ${url}, status code: ${res.status}`)
    process.exit(1)
  }
  return res.json()
}).then(vulns => {
  let badness = 0;
  for (const vuln of vulns) {
    const validRange = vuln.range.replace(', ', ' ')
    if (semver.satisfies(versionStr, validRange, { loose: true, includePrerelease: true })) {
      badness += vuln.badness
    }
  }
  
  console.log(badness)
})


